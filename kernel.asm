;;kernel.asm

;nasm directive - 32 bit
bits 32
section .multiboot
        ;multiboot spec
        align 4
        dd 0x1BADB002            ;magic
        dd 0x00                  ;flags
        dd - (0x1BADB002 + 0x00) ;checksum. m+f+c should be zero

global start
extern kmain	        ;kmain is defined in the c file

start:
    cli 			;block interrupts

    ; update page directory address, since eax and ebx is in use, have to use ecx or other register
    mov ecx, (PAGE_DIRECTORY - 0xC0000000)
    mov cr3, ecx

    ; Enable paging
    mov ecx, cr0
    or ecx, 0x80000000
    mov cr0, ecx

    ; Do a absolute jump to go to higher_half
    lea ecx, [higher_half]
    jmp ecx
higher_half:

    mov esp, stack_space	;set stack pointer
    push ebx
    push eax

    call kmain

loop:
    pause		 	;halt the CPU
    jmp loop

global load_gdt
extern gdt_base

load_gdt:
	lgdt [gdt_base]

	; enable protected mode
	mov eax, cr0
	or al, 1
	mov cr0, eax

	jmp 0x08:.load_gdt_cs_jmp2 ; Far Jump to load code segment
.load_gdt_cs_jmp2:
	
	mov ax, 0x10 ; Load data segmement selectors.
	mov ds, ax
	mov es, ax
	mov fs, ax
	mov gs, ax
	mov ss, ax
	ret


section .bss
    align 16
    resb 8192		;8KB for stack
stack_space:

global PAGE_DIRECTORY
global PAGE_TABLE
section .data
    align 4096
PAGE_TABLE:
	dd 0x00000003
	dd 0x00001003
	dd 0x00002003
	dd 0x00003003
	dd 0x00004003
	dd 0x00005003
	dd 0x00006003
	dd 0x00007003
	dd 0x00008003
	dd 0x00009003
	dd 0x0000a003
	dd 0x0000b003
	dd 0x0000c003
	dd 0x0000d003
	dd 0x0000e003
	dd 0x0000f003
	dd 0x00010003
	dd 0x00011003
	dd 0x00012003
	dd 0x00013003
	dd 0x00014003
	dd 0x00015003
	dd 0x00016003
	dd 0x00017003
	dd 0x00018003
	dd 0x00019003
	dd 0x0001a003
	dd 0x0001b003
	dd 0x0001c003
	dd 0x0001d003
	dd 0x0001e003
	dd 0x0001f003
	dd 0x00020003
	dd 0x00021003
	dd 0x00022003
	dd 0x00023003
	dd 0x00024003
	dd 0x00025003
	dd 0x00026003
	dd 0x00027003
	dd 0x00028003
	dd 0x00029003
	dd 0x0002a003
	dd 0x0002b003
	dd 0x0002c003
	dd 0x0002d003
	dd 0x0002e003
	dd 0x0002f003
	dd 0x00030003
	dd 0x00031003
	dd 0x00032003
	dd 0x00033003
	dd 0x00034003
	dd 0x00035003
	dd 0x00036003
	dd 0x00037003
	dd 0x00038003
	dd 0x00039003
	dd 0x0003a003
	dd 0x0003b003
	dd 0x0003c003
	dd 0x0003d003
	dd 0x0003e003
	dd 0x0003f003
	dd 0x00040003
	dd 0x00041003
	dd 0x00042003
	dd 0x00043003
	dd 0x00044003
	dd 0x00045003
	dd 0x00046003
	dd 0x00047003
	dd 0x00048003
	dd 0x00049003
	dd 0x0004a003
	dd 0x0004b003
	dd 0x0004c003
	dd 0x0004d003
	dd 0x0004e003
	dd 0x0004f003
	dd 0x00050003
	dd 0x00051003
	dd 0x00052003
	dd 0x00053003
	dd 0x00054003
	dd 0x00055003
	dd 0x00056003
	dd 0x00057003
	dd 0x00058003
	dd 0x00059003
	dd 0x0005a003
	dd 0x0005b003
	dd 0x0005c003
	dd 0x0005d003
	dd 0x0005e003
	dd 0x0005f003
	dd 0x00060003
	dd 0x00061003
	dd 0x00062003
	dd 0x00063003
	dd 0x00064003
	dd 0x00065003
	dd 0x00066003
	dd 0x00067003
	dd 0x00068003
	dd 0x00069003
	dd 0x0006a003
	dd 0x0006b003
	dd 0x0006c003
	dd 0x0006d003
	dd 0x0006e003
	dd 0x0006f003
	dd 0x00070003
	dd 0x00071003
	dd 0x00072003
	dd 0x00073003
	dd 0x00074003
	dd 0x00075003
	dd 0x00076003
	dd 0x00077003
	dd 0x00078003
	dd 0x00079003
	dd 0x0007a003
	dd 0x0007b003
	dd 0x0007c003
	dd 0x0007d003
	dd 0x0007e003
	dd 0x0007f003
	dd 0x00080003
	dd 0x00081003
	dd 0x00082003
	dd 0x00083003
	dd 0x00084003
	dd 0x00085003
	dd 0x00086003
	dd 0x00087003
	dd 0x00088003
	dd 0x00089003
	dd 0x0008a003
	dd 0x0008b003
	dd 0x0008c003
	dd 0x0008d003
	dd 0x0008e003
	dd 0x0008f003
	dd 0x00090003
	dd 0x00091003
	dd 0x00092003
	dd 0x00093003
	dd 0x00094003
	dd 0x00095003
	dd 0x00096003
	dd 0x00097003
	dd 0x00098003
	dd 0x00099003
	dd 0x0009a003
	dd 0x0009b003
	dd 0x0009c003
	dd 0x0009d003
	dd 0x0009e003
	dd 0x0009f003
	dd 0x000a0003
	dd 0x000a1003
	dd 0x000a2003
	dd 0x000a3003
	dd 0x000a4003
	dd 0x000a5003
	dd 0x000a6003
	dd 0x000a7003
	dd 0x000a8003
	dd 0x000a9003
	dd 0x000aa003
	dd 0x000ab003
	dd 0x000ac003
	dd 0x000ad003
	dd 0x000ae003
	dd 0x000af003
	dd 0x000b0003
	dd 0x000b1003
	dd 0x000b2003
	dd 0x000b3003
	dd 0x000b4003
	dd 0x000b5003
	dd 0x000b6003
	dd 0x000b7003
	dd 0x000b8003
	dd 0x000b9003
	dd 0x000ba003
	dd 0x000bb003
	dd 0x000bc003
	dd 0x000bd003
	dd 0x000be003
	dd 0x000bf003
	dd 0x000c0003
	dd 0x000c1003
	dd 0x000c2003
	dd 0x000c3003
	dd 0x000c4003
	dd 0x000c5003
	dd 0x000c6003
	dd 0x000c7003
	dd 0x000c8003
	dd 0x000c9003
	dd 0x000ca003
	dd 0x000cb003
	dd 0x000cc003
	dd 0x000cd003
	dd 0x000ce003
	dd 0x000cf003
	dd 0x000d0003
	dd 0x000d1003
	dd 0x000d2003
	dd 0x000d3003
	dd 0x000d4003
	dd 0x000d5003
	dd 0x000d6003
	dd 0x000d7003
	dd 0x000d8003
	dd 0x000d9003
	dd 0x000da003
	dd 0x000db003
	dd 0x000dc003
	dd 0x000dd003
	dd 0x000de003
	dd 0x000df003
	dd 0x000e0003
	dd 0x000e1003
	dd 0x000e2003
	dd 0x000e3003
	dd 0x000e4003
	dd 0x000e5003
	dd 0x000e6003
	dd 0x000e7003
	dd 0x000e8003
	dd 0x000e9003
	dd 0x000ea003
	dd 0x000eb003
	dd 0x000ec003
	dd 0x000ed003
	dd 0x000ee003
	dd 0x000ef003
	dd 0x000f0003
	dd 0x000f1003
	dd 0x000f2003
	dd 0x000f3003
	dd 0x000f4003
	dd 0x000f5003
	dd 0x000f6003
	dd 0x000f7003
	dd 0x000f8003
	dd 0x000f9003
	dd 0x000fa003
	dd 0x000fb003
	dd 0x000fc003
	dd 0x000fd003
	dd 0x000fe003
	dd 0x000ff003
	dd 0x00100003
	dd 0x00101003
	dd 0x00102003
	dd 0x00103003
	dd 0x00104003
	dd 0x00105003
	dd 0x00106003
	dd 0x00107003
	dd 0x00108003
	dd 0x00109003
	dd 0x0010a003
	dd 0x0010b003
	dd 0x0010c003
	dd 0x0010d003
	dd 0x0010e003
	dd 0x0010f003
	dd 0x00110003
	dd 0x00111003
	dd 0x00112003
	dd 0x00113003
	dd 0x00114003
	dd 0x00115003
	dd 0x00116003
	dd 0x00117003
	dd 0x00118003
	dd 0x00119003
	dd 0x0011a003
	dd 0x0011b003
	dd 0x0011c003
	dd 0x0011d003
	dd 0x0011e003
	dd 0x0011f003
	dd 0x00120003
	dd 0x00121003
	dd 0x00122003
	dd 0x00123003
	dd 0x00124003
	dd 0x00125003
	dd 0x00126003
	dd 0x00127003
	dd 0x00128003
	dd 0x00129003
	dd 0x0012a003
	dd 0x0012b003
	dd 0x0012c003
	dd 0x0012d003
	dd 0x0012e003
	dd 0x0012f003
	dd 0x00130003
	dd 0x00131003
	dd 0x00132003
	dd 0x00133003
	dd 0x00134003
	dd 0x00135003
	dd 0x00136003
	dd 0x00137003
	dd 0x00138003
	dd 0x00139003
	dd 0x0013a003
	dd 0x0013b003
	dd 0x0013c003
	dd 0x0013d003
	dd 0x0013e003
	dd 0x0013f003
	dd 0x00140003
	dd 0x00141003
	dd 0x00142003
	dd 0x00143003
	dd 0x00144003
	dd 0x00145003
	dd 0x00146003
	dd 0x00147003
	dd 0x00148003
	dd 0x00149003
	dd 0x0014a003
	dd 0x0014b003
	dd 0x0014c003
	dd 0x0014d003
	dd 0x0014e003
	dd 0x0014f003
	dd 0x00150003
	dd 0x00151003
	dd 0x00152003
	dd 0x00153003
	dd 0x00154003
	dd 0x00155003
	dd 0x00156003
	dd 0x00157003
	dd 0x00158003
	dd 0x00159003
	dd 0x0015a003
	dd 0x0015b003
	dd 0x0015c003
	dd 0x0015d003
	dd 0x0015e003
	dd 0x0015f003
	dd 0x00160003
	dd 0x00161003
	dd 0x00162003
	dd 0x00163003
	dd 0x00164003
	dd 0x00165003
	dd 0x00166003
	dd 0x00167003
	dd 0x00168003
	dd 0x00169003
	dd 0x0016a003
	dd 0x0016b003
	dd 0x0016c003
	dd 0x0016d003
	dd 0x0016e003
	dd 0x0016f003
	dd 0x00170003
	dd 0x00171003
	dd 0x00172003
	dd 0x00173003
	dd 0x00174003
	dd 0x00175003
	dd 0x00176003
	dd 0x00177003
	dd 0x00178003
	dd 0x00179003
	dd 0x0017a003
	dd 0x0017b003
	dd 0x0017c003
	dd 0x0017d003
	dd 0x0017e003
	dd 0x0017f003
	dd 0x00180003
	dd 0x00181003
	dd 0x00182003
	dd 0x00183003
	dd 0x00184003
	dd 0x00185003
	dd 0x00186003
	dd 0x00187003
	dd 0x00188003
	dd 0x00189003
	dd 0x0018a003
	dd 0x0018b003
	dd 0x0018c003
	dd 0x0018d003
	dd 0x0018e003
	dd 0x0018f003
	dd 0x00190003
	dd 0x00191003
	dd 0x00192003
	dd 0x00193003
	dd 0x00194003
	dd 0x00195003
	dd 0x00196003
	dd 0x00197003
	dd 0x00198003
	dd 0x00199003
	dd 0x0019a003
	dd 0x0019b003
	dd 0x0019c003
	dd 0x0019d003
	dd 0x0019e003
	dd 0x0019f003
	dd 0x001a0003
	dd 0x001a1003
	dd 0x001a2003
	dd 0x001a3003
	dd 0x001a4003
	dd 0x001a5003
	dd 0x001a6003
	dd 0x001a7003
	dd 0x001a8003
	dd 0x001a9003
	dd 0x001aa003
	dd 0x001ab003
	dd 0x001ac003
	dd 0x001ad003
	dd 0x001ae003
	dd 0x001af003
	dd 0x001b0003
	dd 0x001b1003
	dd 0x001b2003
	dd 0x001b3003
	dd 0x001b4003
	dd 0x001b5003
	dd 0x001b6003
	dd 0x001b7003
	dd 0x001b8003
	dd 0x001b9003
	dd 0x001ba003
	dd 0x001bb003
	dd 0x001bc003
	dd 0x001bd003
	dd 0x001be003
	dd 0x001bf003
	dd 0x001c0003
	dd 0x001c1003
	dd 0x001c2003
	dd 0x001c3003
	dd 0x001c4003
	dd 0x001c5003
	dd 0x001c6003
	dd 0x001c7003
	dd 0x001c8003
	dd 0x001c9003
	dd 0x001ca003
	dd 0x001cb003
	dd 0x001cc003
	dd 0x001cd003
	dd 0x001ce003
	dd 0x001cf003
	dd 0x001d0003
	dd 0x001d1003
	dd 0x001d2003
	dd 0x001d3003
	dd 0x001d4003
	dd 0x001d5003
	dd 0x001d6003
	dd 0x001d7003
	dd 0x001d8003
	dd 0x001d9003
	dd 0x001da003
	dd 0x001db003
	dd 0x001dc003
	dd 0x001dd003
	dd 0x001de003
	dd 0x001df003
	dd 0x001e0003
	dd 0x001e1003
	dd 0x001e2003
	dd 0x001e3003
	dd 0x001e4003
	dd 0x001e5003
	dd 0x001e6003
	dd 0x001e7003
	dd 0x001e8003
	dd 0x001e9003
	dd 0x001ea003
	dd 0x001eb003
	dd 0x001ec003
	dd 0x001ed003
	dd 0x001ee003
	dd 0x001ef003
	dd 0x001f0003
	dd 0x001f1003
	dd 0x001f2003
	dd 0x001f3003
	dd 0x001f4003
	dd 0x001f5003
	dd 0x001f6003
	dd 0x001f7003
	dd 0x001f8003
	dd 0x001f9003
	dd 0x001fa003
	dd 0x001fb003
	dd 0x001fc003
	dd 0x001fd003
	dd 0x001fe003
	dd 0x001ff003
	times 512 dd 0
PAGE_DIRECTORY:
	dd PAGE_TABLE-0xC0000000+3
	times 767 dd 0
	dd PAGE_TABLE-0xC0000000+3
	times 255 dd 0
